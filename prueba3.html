<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SGBD HR - Pr√°ctica estilo profe (CodeMirror)</title>

    <!-- CodeMirror (v5) por CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">

    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            margin: 0;
            background: #0b0f14;
            color: #e8eef6;
        }

        header {
            padding: 16px 20px;
            background: #0f1722;
            border-bottom: 1px solid #1c2a3a;
        }

        h1 {
            margin: 0;
            font-size: 18px;
        }

        main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            padding: 14px;
        }

        .card {
            background: #0f1722;
            border: 1px solid #1c2a3a;
            border-radius: 12px;
            padding: 14px;
        }

        .muted {
            color: #9fb2c8;
            font-size: 12px;
        }

        .pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            background: #122033;
            border: 1px solid #1c2a3a;
            font-size: 12px;
        }

        button {
            background: #1b6cff;
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        button.secondary {
            background: #122033;
            border: 1px solid #1c2a3a;
            color: #e8eef6;
        }

        button:disabled {
            opacity: .55;
            cursor: not-allowed;
        }

        pre {
            white-space: pre-wrap;
            word-break: break-word;
            background: #0b0f14;
            border: 1px solid #1c2a3a;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0 0;
            font-size: 12px;
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .ok {
            color: #7CFFB2;
            font-weight: 700;
        }

        .bad {
            color: #FF8A8A;
            font-weight: 700;
        }

        details {
            margin-top: 10px;
        }

        summary {
            cursor: pointer;
        }

        .divider {
            height: 1px;
            background: #1c2a3a;
            margin: 12px 0;
        }

        .tiny {
            font-size: 11px;
            color: #9fb2c8;
        }

        @media (max-width: 960px) {
            main {
                grid-template-columns: 1fr;
            }
        }

        .cm-wrap {
            border: 1px solid #1c2a3a;
            border-radius: 10px;
            overflow: hidden;
            background: #0b0f14;
        }

        .CodeMirror {
            height: 180px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 13px;
            background: #0b0f14;
        }

        .cm-line-error {
            background: rgba(255, 105, 180, 0.20);
        }
    </style>
</head>

<body>
    <header>
        <h1>SGBD HR (estilo tu profesor)</h1>
        <div class="muted">
            Ejercicios progresivos ¬∑ Esquema HR completo siempre visible ¬∑ Funciones permitidas:
            <span id="funcs" class="pill"></span>
        </div>
    </header>

    <main>
        <section class="card">
            <div class="row" style="justify-content:space-between;">
                <div class="row">
                    <span class="pill">Nivel: <b id="level">1</b></span>
                    <span class="pill">Hechos: <b id="done">0</b></span>
                    <span class="pill">Tipo: <b id="type">‚Äî</b></span>
                </div>
                <div class="row">
                    <button class="secondary" id="reset">Reiniciar progreso</button>
                    <button id="new">Nuevo ejercicio</button>
                </div>
            </div>

            <div class="divider"></div>

            <h2 style="margin:0 0 6px; font-size:16px;">üìù Enunciado</h2>
            <div id="statement" style="line-height:1.35;"></div>

            <div class="divider"></div>

            <h2 style="margin:0 0 6px; font-size:16px;">‚å®Ô∏è Tu SQL</h2>
            <div class="cm-wrap">
                <textarea id="sql" placeholder="Escribe SOLO el SQL, como en SQLDeveloper..."></textarea>
            </div>

            <div class="row" style="margin-top:10px;">
                <button id="check">Corregir ‚úÖ</button>
                <span id="msg" class="muted"></span>
            </div>

            <details style="margin-top:12px;">
                <summary>‚è±Ô∏è Tiempo (opci√≥n 2)</summary>
                <div class="tiny" style="margin-top:8px;">
                    La web guarda el momento en que se genera el ejercicio y calcula el tiempo cuando pulsas ‚ÄúCorregir‚Äù.
                </div>
                <pre id="timeBox">‚Äî</pre>
            </details>

            <details style="margin-top:12px;">
                <summary>üé® L√≠nea rosa</summary>
                <div class="tiny" style="margin-top:8px;">
                    Marca la l√≠nea del cursor si detecta comillas simples sin cerrar (') o par√©ntesis desbalanceados.
                </div>
            </details>
        </section>

        <section class="card">
            <h2 style="margin:0 0 8px; font-size:16px;">üìò Esquema HR (completo)</h2>
            <div id="schema"></div>

            <details>
                <summary>‚öôÔ∏è Configuraci√≥n (editable)</summary>
                <div class="muted" style="margin-top:8px;">
                    Puedes editar en el c√≥digo: <b>allowedFunctions</b>, <b>difficultyRule</b> y <b>exercises</b>.
                </div>
                <pre id="configPreview"></pre>
            </details>
        </section>
    </main>

    <!-- CodeMirror scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>

    <script>
        // =======================
        // CONFIG
        // =======================
        const CONFIG = {
            allowedFunctions: ["LOWER"],
            difficultyRule: { bumpEvery: 3, maxLevel: 5 },

            schema: [
                { name: "REGIONS", cols: ["REGION_ID", "REGION_NAME"] },
                { name: "COUNTRIES", cols: ["COUNTRY_ID", "COUNTRY_NAME", "REGION_ID"] },
                { name: "LOCATIONS", cols: ["LOCATION_ID", "STREET_ADDRESS", "POSTAL_CODE", "CITY", "STATE_PROVINCE", "COUNTRY_ID"] },
                { name: "DEPARTMENTS", cols: ["DEPARTMENT_ID", "DEPARTMENT_NAME", "MANAGER_ID", "LOCATION_ID"] },
                { name: "JOBS", cols: ["JOB_ID", "JOB_TITLE", "MIN_SALARY", "MAX_SALARY"] },
                { name: "EMPLOYEES", cols: ["EMPLOYEE_ID", "FIRST_NAME", "LAST_NAME", "EMAIL", "PHONE_NUMBER", "HIRE_DATE", "JOB_ID", "SALARY", "COMMISSION_PCT", "MANAGER_ID", "DEPARTMENT_ID"] },
                { name: "JOB_HISTORY", cols: ["EMPLOYEE_ID", "START_DATE", "END_DATE", "JOB_ID", "DEPARTMENT_ID"] },
            ],

            // ‚úÖ Ahora se corrige por REGLAS (flexible), NO por texto exacto
            exercises: [
                // Nivel 1
                {
                    level: 1, type: "SELECT",
                    statement: "Visualizar el <b>nombre</b> y el <b>n√∫mero de tel√©fono</b> de los empleados.",
                    rules: {
                        from: "employees",
                        mustSelectAnyOrder: ["first_name", "phone_number"]
                    }
                },
                {
                    level: 1, type: "SELECT",
                    statement: "Visualizar el <b>nombre</b> y el <b>tipo de trabajo</b> (FIRST_NAME, JOB_ID). Cabecera <b>NOMBRE</b> y <b>Tipo de Trabajo</b>.",
                    rules: {
                        from: "employees",
                        mustSelectAnyOrder: ["first_name", "job_id"]
                    }
                },
                {
                    level: 1, type: "ORDER BY",
                    statement: "Listar <b>nombre</b>, <b>salario</b> y <b>tel√©fono</b> ordenados <b>descendentemente por salario</b>.",
                    rules: {
                        from: "employees",
                        mustSelectAnyOrder: ["first_name", "salary", "phone_number"],
                        orderBy: { col: "salary", dir: "desc" }
                    }
                },

                // Nivel 2
                {
                    level: 2, type: "WHERE",
                    statement: "Averigua los empleados que trabajen en el <b>departamento 100</b>.",
                    rules: {
                        from: "employees",
                        whereAll: ["department_id = 100"]
                    }
                },
                {
                    level: 2, type: "WHERE",
                    statement: "Seleccionar los empleados cuyo tipo de trabajo sea <b>'ST_CLERK'</b>.",
                    rules: {
                        from: "employees",
                        whereAll: ["job_id = 'st_clerk'"]
                    }
                },
                {
                    level: 2, type: "WHERE",
                    statement: "Indicar los datos de los empleados con apellido <b>'Smith'</b> (LAST_NAME).",
                    rules: {
                        from: "employees",
                        whereAll: ["last_name = 'smith'"]
                    }
                },

                // Nivel 3
                {
                    level: 3, type: "BETWEEN",
                    statement: "Averiguar empleados entre <b>departamento 40</b> y <b>60</b> (BETWEEN).",
                    rules: {
                        from: "employees",
                        whereAny: ["department_id between 40 and 60"]
                    }
                },
                {
                    level: 3, type: "IN",
                    statement: "Averiguar empleados de departamentos <b>30</b>, <b>60</b> y <b>90</b> (IN).",
                    rules: {
                        from: "employees",
                        whereAny: ["department_id in (30,60,90)", "department_id in (30, 60, 90)"]
                    }
                },
                {
                    level: 3, type: "FECHAS",
                    statement: "Empleados que empezaron a trabajar <b>a partir del a√±o 2006</b> (sin funciones nuevas).",
                    rules: {
                        from: "employees",
                        whereAny: ["hire_date >= date '2006-01-01'"]
                    }
                },

                // Nivel 4
                {
                    level: 4, type: "LIKE",
                    statement: "Datos de empleados cuyo <b>FIRST_NAME</b> empieza por <b>'J'</b> (LIKE).",
                    rules: {
                        from: "employees",
                        whereAny: ["first_name like 'j%'"]
                    }
                },
                {
                    level: 4, type: "IS NULL",
                    statement: "Listar ciudades de <b>LOCATIONS</b> que <b>no tienen STATE_PROVINCE</b> (IS NULL).",
                    rules: {
                        from: "locations",
                        mustSelectAnyOrder: ["city"],
                        whereAny: ["state_province is null"]
                    }
                },
                {
                    level: 4, type: "AND",
                    statement: "Nombre, fecha de entrada y job_id de empleados <b>IT_PROG</b> que ganen <b>menos de 6000</b>.",
                    rules: {
                        from: "employees",
                        mustSelectAnyOrder: ["first_name", "hire_date", "job_id"],
                        whereAll: ["job_id = 'it_prog'", "salary < 6000"]
                    }
                },

                // Nivel 5 (seguimos simple: comprobaci√≥n por ‚Äútrozos‚Äù)
                {
                    level: 5, type: "SUBCONSULTA",
                    statement: "Compa√±eros que trabajan en el mismo departamento que <b>John Chen</b> (subconsulta).",
                    rules: {
                        from: "employees",
                        whereAll: ["department_id = (", "first_name = 'john'", "last_name = 'chen'"]
                    }
                },
                {
                    level: 5, type: "SUBCONSULTA",
                    statement: "¬øQu√© departamentos tienen su sede en <b>Toronto</b>? (subconsulta).",
                    rules: {
                        from: "departments",
                        whereAll: ["location_id = (", "from locations", "city = 'toronto'"]
                    }
                }
            ]
        };

        // =======================
        // HELPERS
        // =======================
        const $ = (id) => document.getElementById(id);
        const storeKey = "sgbd_hr_project_v2_rules";

        function normalizeForCheck(sql) {
            return (sql || "")
                .replace(/--.*$/gm, "")               // comentarios --
                .replace(/\/\*[\s\S]*?\*\//g, "")     // comentarios /* */
                .trim()
                .replace(/\s+/g, " ")
                .replace(/\s*;\s*$/, ";")
                .toLowerCase();
        }

        function stripStrings(sql) {
            // Reemplaza literales '...' por '' para que no interfieran en comprobaciones
            return sql.replace(/'([^']|'')*'/g, "''");
        }

        // ‚úÖ CORREGIDO: no confunde "AS (" con funci√≥n.
        function hasOnlyAllowedFunctions(sql) {
            const allowed = new Set(CONFIG.allowedFunctions.map(x => x.toLowerCase()));
            const sqlKeywords = new Set([
                "as", "in", "values", "into", "on", "from", "where", "select", "order",
                "group", "having", "between", "like", "and", "or", "not", "fetch", "distinct"
            ]);

            const hits = [];
            const re = /\b([a-zA-Z_][a-zA-Z0-9_]*)\s*\(/g;
            let m;

            while ((m = re.exec(sql)) !== null) {
                const word = m[1].toLowerCase();
                if (sqlKeywords.has(word)) continue;
                if (!allowed.has(word)) hits.push(m[1]);
            }
            return { ok: hits.length === 0, hits };
        }

        function extractFromTable(sql) {
            const m = sql.match(/\bfrom\s+([a-zA-Z_][a-zA-Z0-9_]*)\b/);
            return m ? m[1].toLowerCase() : null;
        }

        function extractOrderBy(sql) {
            const m = sql.match(/\border\s+by\s+([a-zA-Z_][a-zA-Z0-9_]*)(?:\s+(asc|desc))?\b/);
            if (!m) return null;
            return { col: m[1].toLowerCase(), dir: (m[2] || "asc").toLowerCase() };
        }

        function extractSelectPart(sql) {
            // Muy simple: entre select y from
            const m = sql.match(/\bselect\s+([\s\S]*?)\s+\bfrom\b/);
            return m ? m[1].toLowerCase() : "";
        }

        function hasToken(selectPart, token) {
            // token como palabra completa (first_name etc.)
            const re = new RegExp(`\\b${token.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")}\\b`, "i");
            return re.test(selectPart);
        }

        function containsAll(sql, arr) {
            return arr.every(x => sql.includes(x));
        }

        function containsAny(sql, arr) {
            return arr.some(x => sql.includes(x));
        }

        function checkByRules(userRawSql, rules) {
            const n = normalizeForCheck(userRawSql);
            const noStr = stripStrings(n);

            // FROM
            if (rules.from) {
                const from = extractFromTable(noStr);
                if (from !== rules.from.toLowerCase()) {
                    return { ok: false, reason: `Falta o no coincide FROM ${rules.from}` };
                }
            }

            // SELECT columnas (en cualquier orden, con o sin alias)
            if (rules.mustSelectAnyOrder && rules.mustSelectAnyOrder.length) {
                const selectPart = extractSelectPart(noStr);
                for (const col of rules.mustSelectAnyOrder) {
                    if (!hasToken(selectPart, col.toLowerCase())) {
                        return { ok: false, reason: `En SELECT falta la columna ${col}` };
                    }
                }
            }

            // WHERE: todo obligatorio
            if (rules.whereAll && rules.whereAll.length) {
                for (const frag of rules.whereAll) {
                    if (!noStr.includes(frag)) {
                        return { ok: false, reason: `En WHERE falta: ${frag}` };
                    }
                }
            }

            // WHERE: alguna opci√≥n v√°lida
            if (rules.whereAny && rules.whereAny.length) {
                if (!containsAny(noStr, rules.whereAny)) {
                    return { ok: false, reason: `En WHERE no aparece ninguna condici√≥n esperada` };
                }
            }

            // ORDER BY
            if (rules.orderBy) {
                const ob = extractOrderBy(noStr);
                if (!ob) return { ok: false, reason: `Falta ORDER BY ${rules.orderBy.col} ${rules.orderBy.dir}` };
                if (ob.col !== rules.orderBy.col.toLowerCase()) return { ok: false, reason: `ORDER BY debe ser por ${rules.orderBy.col}` };
                if ((ob.dir || "asc") !== rules.orderBy.dir.toLowerCase()) return { ok: false, reason: `ORDER BY debe ser ${rules.orderBy.dir.toUpperCase()}` };
            }

            return { ok: true, reason: "OK" };
        }

        // =======================
        // UI
        // =======================
        function renderSchema() {
            const wrap = $("schema");
            wrap.innerHTML = "";
            CONFIG.schema.forEach(t => {
                const div = document.createElement("div");
                div.style.margin = "10px 0";
                div.innerHTML = `
        <div class="pill">üü¶ <b>${t.name}</b></div>
        <div class="muted" style="margin:6px 0 0 8px;">- ${t.cols.join("<br>- ")}</div>`;
                wrap.appendChild(div);
            });
        }

        function loadProgress() {
            try {
                return JSON.parse(localStorage.getItem(storeKey)) || {
                    done: 0,
                    level: 1,
                    lastIndexByLevel: {},
                    exerciseStartedAt: null,
                    lastExerciseId: null
                };
            } catch {
                return { done: 0, level: 1, lastIndexByLevel: {}, exerciseStartedAt: null, lastExerciseId: null };
            }
        }

        function saveProgress(p) { localStorage.setItem(storeKey, JSON.stringify(p)); }

        function poolForLevel(level) {
            return CONFIG.exercises.filter(e => e.level === level);
        }

        function pickExercise(level, lastIndex) {
            const pool = poolForLevel(level);
            if (pool.length === 0) return null;
            const idx = (lastIndex + 1) % pool.length;
            return { ex: pool[idx], idx };
        }

        function formatDuration(ms) {
            if (ms == null) return "‚Äî";
            const totalSec = Math.max(0, Math.round(ms / 1000));
            const min = Math.floor(totalSec / 60);
            const sec = totalSec % 60;
            if (min === 0) return `${sec}s`;
            return `${min}m ${sec}s`;
        }

        function updateUI() {
            const p = loadProgress();
            $("done").textContent = String(p.done);
            $("level").textContent = String(p.level);
            $("funcs").textContent = CONFIG.allowedFunctions.join(", ");
            const preview = {
                allowedFunctions: CONFIG.allowedFunctions,
                difficultyRule: CONFIG.difficultyRule,
                exercises: CONFIG.exercises.map(e => ({ level: e.level, type: e.type, statement: e.statement }))
            };
            $("configPreview").textContent = JSON.stringify(preview, null, 2);
        }

        function showTime(label) {
            const p = loadProgress();
            const start = p.exerciseStartedAt;
            const elapsed = (start ? (Date.now() - start) : null);
            $("timeBox").textContent = `${label}\nEjercicio: ${p.lastExerciseId ?? "‚Äî"}\nTiempo aprox: ${formatDuration(elapsed)}`;
            return elapsed;
        }

        // =======================
        // CodeMirror
        // =======================
        const editor = CodeMirror.fromTextArea(document.getElementById("sql"), {
            mode: "text/x-sql",
            theme: "material-darker",
            lineNumbers: true,
            indentUnit: 2,
            tabSize: 2,
            matchBrackets: true,
            styleActiveLine: true
        });

        let lastMarkedLine = null;

        function basicErrorCheck(sql) {
            const quoteCount = (sql.match(/'/g) || []).length;
            const quotesOdd = (quoteCount % 2) === 1;

            let bal = 0;
            for (const ch of sql) {
                if (ch === "(") bal++;
                if (ch === ")") bal--;
            }
            const parenBad = (bal !== 0);

            return { hasError: quotesOdd || parenBad };
        }

        function clearLineMark() {
            if (lastMarkedLine !== null) {
                editor.removeLineClass(lastMarkedLine, "background", "cm-line-error");
                lastMarkedLine = null;
            }
        }

        function markCurrentLineIfError() {
            clearLineMark();
            const sql = editor.getValue();
            const check = basicErrorCheck(sql);
            if (!check.hasError) return;

            const cur = editor.getCursor();
            lastMarkedLine = cur.line;
            editor.addLineClass(lastMarkedLine, "background", "cm-line-error");
        }

        editor.on("change", () => markCurrentLineIfError());
        editor.on("cursorActivity", () => markCurrentLineIfError());

        // =======================
        // Ejercicios
        // =======================
        function newExercise() {
            const p = loadProgress();
            const lastIndex = p.lastIndexByLevel[p.level] ?? -1;
            const picked = pickExercise(p.level, lastIndex);

            if (!picked) {
                $("statement").innerHTML = "No hay ejercicios para este nivel. A√±ade m√°s en CONFIG.exercises.";
                $("type").textContent = "‚Äî";
                return;
            }

            p.lastIndexByLevel[p.level] = picked.idx;
            p.exerciseStartedAt = Date.now();
            p.lastExerciseId = `${p.level}:${picked.idx}`;
            saveProgress(p);

            $("statement").innerHTML = picked.ex.statement;
            $("type").textContent = picked.ex.type || "‚Äî";

            editor.setValue("");
            editor.focus();
            $("msg").textContent = "";
            $("timeBox").textContent = "Inicio registrado. Responde y pulsa ‚ÄúCorregir‚Äù para ver el tiempo.";
            clearLineMark();
        }

        function markDoneAuto() {
            const p = loadProgress();
            p.done += 1;

            const bumpEvery = CONFIG.difficultyRule.bumpEvery;
            const maxLevel = CONFIG.difficultyRule.maxLevel;
            if (p.done % bumpEvery === 0) {
                p.level = Math.min(p.level + 1, maxLevel);
            }

            saveProgress(p);
            updateUI();
            newExercise();
        }

        function checkSolution() {
            const userSQL = editor.getValue();

            // 1) Funciones permitidas
            const fnCheck = hasOnlyAllowedFunctions(userSQL);
            if (!fnCheck.ok) {
                $("msg").innerHTML =
                    `<span class="bad">‚ùå Funciones no permitidas:</span> ${fnCheck.hits.join(", ")}. Permitidas: ${CONFIG.allowedFunctions.join(", ")}`;
                showTime("Tiempo al corregir:");
                return;
            }

            // 2) Localizar ejercicio actual
            const p = loadProgress();
            const parts = (p.lastExerciseId || "").split(":");
            const idx = (parts.length === 2) ? Number(parts[1]) : null;
            const pool = poolForLevel(p.level);

            if (idx === null || !pool[idx]) {
                $("msg").innerHTML = `<span class="bad">‚ùå Error interno.</span> Pulsa ‚ÄúNuevo ejercicio‚Äù.`;
                showTime("Tiempo al corregir:");
                return;
            }

            const rules = pool[idx].rules || {};
            const result = checkByRules(userSQL, rules);

            if (result.ok) {
                $("msg").innerHTML = `<span class="ok">‚úÖ Correcto</span> Pasando al siguiente...`;
                showTime("Tiempo al corregir:");
                setTimeout(() => markDoneAuto(), 450);
            } else {
                $("msg").innerHTML = `<span class="bad">‚ùå Incorrecto</span> ${result.reason}`;
                showTime("Tiempo al corregir:");
            }
        }

        function resetProgress() {
            localStorage.removeItem(storeKey);
            updateUI();
            newExercise();
        }

        // INIT
        renderSchema();
        updateUI();
        newExercise();

        document.getElementById("new").addEventListener("click", newExercise);
        document.getElementById("check").addEventListener("click", checkSolution);
        document.getElementById("reset").addEventListener("click", resetProgress);
    </script>
</body>

</html>